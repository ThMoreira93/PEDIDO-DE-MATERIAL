
<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Painel Admin</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body onload="verificaLogin()">

<div id="loginContainer" style="display:block;">
  <h2>Login</h2>
  <form onsubmit="return login(event)">
    <input type="text" id="user" placeholder="Usuário" required />
    <input type="password" id="pass" placeholder="Senha" required />
    <button type="submit">Entrar</button>
  </form>
  <p id="loginErro" style="color:red; display:none;">Usuário ou senha incorretos.</p>
</div>

<div id="conteudo" style="display:none;">
  <h2>Status dos Pedidos</h2>
  <canvas id="graficoStatus" style="max-width:500px;margin:30px auto;display:block;"></canvas>

  <div style="margin-top: 15px;">
    <input type="file" id="arquivoStatus" accept=".xlsx">
    <button onclick="atualizarStatusEmMassa()">Atualizar Status</button>
    <a href="Modelo_Atualizacao_Status.xlsx" download style="margin-left:15px;">Baixar Modelo</a>
  </div>

  <input id="buscaTexto" placeholder="Buscar..." />
  <select id="filtroStatus">
    <option value="">Todos os Status</option>
    <option>Solicitação Recebida</option>
    <option>Reserva Gerada</option>
    <option>Aguardando Verba</option>
    <option>Reserva Apropriada</option>
    <option>Disponível para Retirada</option>
    <option>Material Entregue</option>
  </select>

  <div id="listaPedidos" style="margin-top:20px;"></div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCv7vfGMSobE1n0M1CECl46LdMy3pdrxh4",
  authDomain: "pedido-de-material---ilheus.firebaseapp.com",
  projectId: "pedido-de-material---ilheus",
  storageBucket: "pedido-de-material---ilheus.firebasestorage.app",
  messagingSenderId: "155845988594",
  appId: "1:155845988594:web:322f34f9790f605a92006b"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let dadosPedidos = [];
let todosPedidos = [];

function login(event) {
  event.preventDefault();
  const usuario = document.getElementById("user").value;
  const senha = document.getElementById("pass").value;
  if (usuario === "CLB354374" && senha === "novo") {
    localStorage.setItem("loginOK", new Date().getTime());
    document.getElementById("loginContainer").style.display = "none";
    document.getElementById("conteudo").style.display = "block";
    carregarPedidos();
  } else {
    document.getElementById("loginErro").style.display = "block";
  }
}

function verificaLogin() {
  const login = localStorage.getItem("loginOK");
  if (login && new Date().getTime() - parseInt(login) < 30 * 60 * 1000) {
    document.getElementById("loginContainer").style.display = "none";
    document.getElementById("conteudo").style.display = "block";
    carregarPedidos();
  }
}

function carregarPedidos() {
  db.collection("pedidos").orderBy("data", "desc").onSnapshot(snapshot => {
    dadosPedidos = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    todosPedidos = dadosPedidos;
    renderizarPedidos(dadosPedidos);
    gerarGraficoStatus(dadosPedidos);
  });
}

function renderizarPedidos(pedidos) {
  const div = document.getElementById("listaPedidos");
  div.innerHTML = "";
  pedidos.forEach(p => {
    const el = document.createElement("div");
    el.style.background = "#fff";
    el.style.borderLeft = "5px solid #28a745";
    el.style.borderRadius = "8px";
    el.style.marginBottom = "15px";
    el.style.padding = "15px";
    el.style.boxShadow = "0 2px 5px rgba(0,0,0,0.1)";
    el.innerHTML = `
      <b>Número:</b> ${p.numero}<br>
      <b>Colaborador:</b> ${p.colaborador}<br>
      <b>Status:</b> ${p.status}<br>
      <b>Data:</b> ${new Date(p.data).toLocaleString()}<br>
      <b>Observações:</b> ${p.observacoes || ""}<br>
      <b>Materiais:</b><ul>${p.materiais.map(m => `<li>${m.material} — ${m.quantidade}</li>`).join("")}</ul>
    `;
    div.appendChild(el);
  });
}

function gerarGraficoStatus(pedidos) {
  const contagem = {
    "Solicitação Recebida": 0,
    "Reserva Gerada": 0,
    "Aguardando Verba": 0,
    "Reserva Apropriada": 0,
    "Disponível para Retirada": 0,
    "Material Entregue": 0
  };
  pedidos.forEach(p => contagem[p.status] = (contagem[p.status] || 0) + 1);
  const ctx = document.getElementById("graficoStatus").getContext("2d");
  new Chart(ctx, {
    type: "pie",
    data: {
      labels: Object.keys(contagem),
      datasets: [{
        data: Object.values(contagem),
        backgroundColor: ["#28a745", "#ffc107", "#17a2b8", "#ff5722", "#6c757d", "#007bff"]
      }]
    },
    options: {
      plugins: {
        datalabels: {
          color: "#fff",
          font: { weight: "bold" },
          formatter: value => value
        }
      }
    },
    plugins: [ChartDataLabels]
  });
}

document.getElementById("filtroStatus").addEventListener("change", function() {
  const status = this.value;
  const texto = document.getElementById("buscaTexto").value.toLowerCase();
  const filtrado = todosPedidos.filter(p => {
    const combinaStatus = !status || p.status === status;
    const combinaTexto = !texto || p.colaborador?.toLowerCase().includes(texto) || p.telefone?.includes(texto) || p.numero?.includes(texto);
    return combinaStatus && combinaTexto;
  });
  renderizarPedidos(filtrado);
  gerarGraficoStatus(filtrado);
});

document.getElementById("buscaTexto").addEventListener("input", function() {
  document.getElementById("filtroStatus").dispatchEvent(new Event("change"));
});

function atualizarStatusEmMassa() {
  const fileInput = document.getElementById("arquivoStatus");
  const file = fileInput.files[0];
  if (!file) {
    alert("Selecione um arquivo Excel.");
    return;
  }

  const reader = new FileReader();
  reader.onload = function(e) {
    const data = new Uint8Array(e.target.result);
    const workbook = XLSX.read(data, { type: "array" });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(sheet);

    if (!rows || !rows.length) {
      alert("Planilha vazia ou inválida.");
      return;
    }

    let atualizados = 0;
    const promises = rows.map(row => {
      const numero = String(row["Número do Pedido"]).trim();
      const novoStatus = String(row["Novo Status"]).trim();

      return db.collection("pedidos").where("numero", "==", numero).get()
        .then(snapshot => {
          if (!snapshot.empty) {
            const batch = db.batch();
            snapshot.forEach(doc => {
              batch.update(doc.ref, { status: novoStatus });
            });
            atualizados++;
            return batch.commit();
          }
        });
    });

    Promise.all(promises).then(() => {
      alert(`Atualização concluída. ${atualizados} pedido(s) modificados.`);
      fileInput.value = "";
    }).catch(err => {
      console.error("Erro ao atualizar pedidos:", err);
      alert("Erro ao atualizar pedidos.");
    });
  };

  reader.readAsArrayBuffer(file);
}
</script>
</body>
</html>
