
<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Painel Admin - Pedido de Material</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f9f9f9;
      margin: 0;
      padding: 20px;
    }
    #loginContainer, #conteudo {
      max-width: 1000px;
      margin: auto;
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }
    h2 {
      text-align: center;
      color: #2e7d32;
    }
    input, select, button {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      font-size: 14px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    button {
      background: #2e7d32;
      color: white;
      font-weight: bold;
    }
    button:hover {
      background: #1b5e20;
    }
    .pedido {
      padding: 20px;
      margin: 20px 0;
      background: #f4f4f4;
      border-left: 6px solid #007bff;
      border-radius: 8px;
    }
    .numero-pedido {
      color: #ff9800;
      font-weight: bold;
      font-size: 16px;
    }
    .status-pedido {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 6px;
      color: white;
      font-weight: bold;
      margin-bottom: 10px;
    }
    .status-Solicitação\ Recebida { background: #9c27b0; }
    .status-Reserva\ Gerada { background: #007bff; }
    .status-Aguardando\ Verba { background: #e53935; }
    .status-Reserva\ Apropriada { background: #ec407a; }
    .status-Disponível\ para\ Retirada { background: #2e7d32; }
    .status-Material\ Entregue { background: #757575; }
    #graficoStatus {
      max-width: 500px;
      margin: 30px auto;
    }
  </style>
</head>
<body onload="verificaLogin()">

<div id="loginContainer">
  <h2>Login</h2>
  <form onsubmit="login(event); return false;">
    <input type="text" id="user" placeholder="Usuário" required />
    <input type="password" id="pass" placeholder="Senha" required />
    <button type="submit">Entrar</button>
    <p id="loginErro" style="color:red; display:none;">Usuário ou senha incorretos.</p>
  </form>
</div>

<div id="conteudo" style="display:none;">
  <h2>Painel de Pedidos</h2>
  <input id="buscaTexto" placeholder="Buscar pedido..." />
  <select id="filtroStatus">
    <option value="">Todos os Status</option>
    <option>Solicitação Recebida</option>
    <option>Reserva Gerada</option>
    <option>Aguardando Verba</option>
    <option>Reserva Apropriada</option>
    <option>Disponível para Retirada</option>
    <option>Material Entregue</option>
  </select>
  <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
    <input type="file" id="arquivoStatus" />
    <button onclick="atualizarStatusEmMassa()">Atualizar em Massa</button>
    <button onclick="exportarExcel()">Exportar Excel</button>
    <a href="Modelo_Atualizacao_Status.xlsx" download><button>Baixar Modelo</button></a>
  </div>
  <canvas id="graficoStatus"></canvas>
  <div id="listaPedidos" style="margin-top:30px;"></div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCv7vfGMSobE1n0M1CECl46LdMy3pdrxh4",
  authDomain: "pedido-de-material---ilheus.firebaseapp.com",
  projectId: "pedido-de-material---ilheus",
  storageBucket: "pedido-de-material---ilheus.firebasestorage.app",
  messagingSenderId: "155845988594",
  appId: "1:155845988594:web:322f34f9790f605a92006b"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let todosPedidos = [];

function login(event) {
  const u = document.getElementById("user").value;
  const p = document.getElementById("pass").value;
  if (u === "CLB354374" && p === "novo") {
    localStorage.setItem("loginOK", Date.now());
    document.getElementById("loginContainer").style.display = "none";
    document.getElementById("conteudo").style.display = "block";
    carregarPedidos();
  } else {
    document.getElementById("loginErro").style.display = "block";
  }
}

function verificaLogin() {
  const l = localStorage.getItem("loginOK");
  if (l && Date.now() - l < 1800000) {
    document.getElementById("loginContainer").style.display = "none";
    document.getElementById("conteudo").style.display = "block";
    carregarPedidos();
  }
}

function carregarPedidos() {
  db.collection("pedidos").orderBy("data", "desc").onSnapshot(snap => {
    todosPedidos = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    renderizarPedidos(todosPedidos);
    gerarGraficoStatus(todosPedidos);
  });
}

function renderizarPedidos(lista) {
  const div = document.getElementById("listaPedidos");
  div.innerHTML = "";
  lista.forEach(p => {
    const el = document.createElement("div");
    el.className = "pedido";
    const historico = (p.historico || []).map(h => `<li>${new Date(h.data).toLocaleString()} - ${h.status}</li>`).join("");
    el.innerHTML = `
      <div class="numero-pedido">Pedido: ${p.numero}</div>
      <b>Colaborador:</b> ${p.colaborador}<br>
      <span class="status-pedido status-${p.status}">${p.status}</span><br>
      <b>Data:</b> ${new Date(p.data).toLocaleString()}<br>
      <b>Materiais:</b><ul>${p.materiais.map(m => `<li>${m.material} - ${m.quantidade}</li>`).join("")}</ul>
      <b>Histórico:</b><ul>${historico}</ul>
      <select id="status_${p.id}">
        ${["Solicitação Recebida", "Reserva Gerada", "Aguardando Verba", "Reserva Apropriada", "Disponível para Retirada", "Material Entregue"]
          .map(s => `<option value="${s}" ${s === p.status ? "selected" : ""}>${s}</option>`).join("")}
      </select>
      <button onclick="atualizarStatusIndividual('${p.id}')">Alterar</button>
    `;
    div.appendChild(el);
  });
}

function atualizarStatusIndividual(id) {
  const novo = document.getElementById("status_" + id).value;
  const ref = db.collection("pedidos").doc(id);
  ref.get().then(doc => {
    const hist = doc.data().historico || [];
    hist.push({ status: novo, data: new Date().toISOString() });
    ref.ref.update({ status: novo, historico: hist });
  });
}

function aplicarFiltros() {
  const status = document.getElementById("filtroStatus").value;
  const texto = document.getElementById("buscaTexto").value.toLowerCase();
  const filtrado = todosPedidos.filter(p =>
    (!status || p.status === status) &&
    (!texto || p.colaborador.toLowerCase().includes(texto) || p.numero.includes(texto))
  );
  renderizarPedidos(filtrado);
  gerarGraficoStatus(filtrado);
}
document.getElementById("filtroStatus").addEventListener("change", aplicarFiltros);
document.getElementById("buscaTexto").addEventListener("input", aplicarFiltros);

function atualizarStatusEmMassa() {
  const file = document.getElementById("arquivoStatus").files[0];
  if (!file) return alert("Selecione um arquivo.");
  const reader = new FileReader();
  reader.onload = function(e) {
    const dados = XLSX.utils.sheet_to_json(XLSX.read(new Uint8Array(e.target.result), { type: "array" }).Sheets.Sheet1);
    const promessas = dados.map(row =>
      db.collection("pedidos").where("numero", "==", String(row["Número do Pedido"])).get().then(snap => {
        if (!snap.empty) {
          const batch = db.batch();
          snap.forEach(doc => {
            const hist = doc.data().historico || [];
            hist.push({ status: row["Novo Status"], data: new Date().toISOString() });
            batch.update(doc.ref, { status: row["Novo Status"], historico: hist });
          });
          return batch.commit();
        }
      })
    );
    Promise.all(promessas).then(() => alert("Atualizado com sucesso"));
  };
  reader.readAsArrayBuffer(file);
}

function exportarExcel() {
  const wb = XLSX.utils.book_new();
  const linhas = [];
  todosPedidos.forEach(p =>
    p.materiais.forEach(m => linhas.push({
      "Número do Pedido": p.numero,
      "Colaborador": p.colaborador,
      "Status": p.status,
      "Material": m.material,
      "Quantidade": m.quantidade,
      "Observações": p.observacoes || "",
      "Data": new Date(p.data).toLocaleString()
    }))
  );
  const ws = XLSX.utils.json_to_sheet(linhas);
  XLSX.utils.book_append_sheet(wb, ws, "Pedidos");
  XLSX.writeFile(wb, "Pedidos_Materiais.xlsx");
}

function gerarGraficoStatus(pedidos) {
  const contagem = {
    "Solicitação Recebida": 0,
    "Reserva Gerada": 0,
    "Aguardando Verba": 0,
    "Reserva Apropriada": 0,
    "Disponível para Retirada": 0,
    "Material Entregue": 0
  };
  pedidos.forEach(p => contagem[p.status] = (contagem[p.status] || 0) + 1);
  new Chart(document.getElementById("graficoStatus"), {
    type: "pie",
    data: {
      labels: Object.keys(contagem),
      datasets: [{
        data: Object.values(contagem),
        backgroundColor: ["#9c27b0", "#007bff", "#e53935", "#ec407a", "#2e7d32", "#757575"]
      }]
    },
    options: {
      plugins: {
        datalabels: {
          color: "#fff",
          font: { weight: "bold" },
          formatter: v => v
        }
      }
    },
    plugins: [ChartDataLabels]
  });
}
</script>
</body>
</html>
