<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gestão de Materiais - Painel Administrativo</title>

  <!-- Fonts & Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>

  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

  <!-- Chart.js & Datalabels -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

  <!-- XLSX -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root {
      --primary-50:#e3f2fd; --primary-100:#bbdefb; --primary-200:#90caf9; --primary-300:#64b5f6;
      --primary-400:#42a5f5; --primary-500:#2196f3; --primary-600:#1e88e5; --primary-700:#1976d2;
      --primary-800:#1565c0; --primary-900:#0d47a1;
      --secondary-500:#ff9800;
      --neutral-50:#fafafa; --neutral-100:#f5f5f5; --neutral-200:#eeeeee; --neutral-300:#e0e0e0;
      --neutral-400:#bdbdbd; --neutral-500:#9e9e9e; --neutral-600:#757575; --neutral-700:#616161;
      --neutral-800:#424242; --neutral-900:#212121;

      --status-received:#9c27b0;
      --status-generated:#1976d2;
      --status-waiting:#FFA500;
      --status-appropriated:#ec407a;
      --status-available:#757575;
      --status-delivered:#2e7d32;
      --status-canceled:#ff0000;
      --status-stock:#7cb342;
      --status-awaitmat:#fb8c00;
    }
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Roboto',sans-serif;background:var(--neutral-100);color:var(--neutral-900)}

    .app-container{display:flex;min-height:100vh}
    .sidebar{width:260px;background:var(--neutral-900);color:#fff;display:flex;flex-direction:column;position:fixed;height:100vh;z-index:100}
    .sidebar-header{padding:16px;display:flex;align-items:center;border-bottom:1px solid rgba(255,255,255,.1)}
    .sidebar-header h1{font-size:1.1rem;font-weight:600;margin-left:12px}
    .sidebar-nav{flex:1;overflow:auto;padding:8px 0}
    .nav-item a{display:flex;align-items:center;padding:10px 16px;color:#ddd;text-decoration:none}
    .nav-item a:hover{background:rgba(255,255,255,.08);color:#fff}
    .nav-item.active a{background:var(--primary-700);border-left:4px solid var(--primary-300);color:#fff}
    .nav-item i{width:20px;margin-right:10px;text-align:center}
    .sidebar-footer{padding:16px;border-top:1px solid rgba(255,255,255,.1)}
    .user-info{display:flex;align-items:center;margin-bottom:10px}
    .user-details{display:flex;flex-direction:column}
    .user-name{font-weight:600}
    .user-role{font-size:.75rem;color:#bbb}
    .btn-logout{width:100%;border:1px solid rgba(255,255,255,.2);background:transparent;color:#ddd;border-radius:6px;padding:8px;cursor:pointer}
    .btn-logout:hover{background:rgba(255,255,255,.1)}

    .main-content{flex:1;margin-left:260px;padding:20px}
    .content-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
    .page-title h2{font-size:1.6rem}
    .search-input{padding:10px 14px;border:1px solid var(--neutral-300);border-radius:8px;width:260px}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:8px;border:none;cursor:pointer;font-weight:600}
    .btn-primary{background:var(--primary-600);color:#fff}
    .btn-secondary{background:var(--neutral-200)}
    .btn-icon{width:36px;height:36px;display:inline-flex;align-items:center;justify-content:center;border-radius:8px;border:none;background:transparent;color:var(--neutral-700);cursor:pointer}

    .card{background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.05);margin-bottom:16px;overflow:hidden}
    .card-header{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;border-bottom:1px solid var(--neutral-200)}
    .card-body{padding:16px}
    .kpi-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin-bottom:16px}
    .kpi-card{display:flex;gap:12px;align-items:center;padding:16px}
    .kpi-icon{width:46px;height:46px;border-radius:10px;background:var(--primary-100);display:flex;align-items:center;justify-content:center;color:var(--primary-800)}

    .grid-layout{display:grid;grid-template-columns:repeat(auto-fit,minmax(380px,1fr));gap:12px}

    .table{width:100%;border-collapse:collapse}
    .table th,.table td{padding:10px 12px;border-bottom:1px solid var(--neutral-200);text-align:left}
    .badge{display:inline-flex;align-items:center;padding:4px 10px;border-radius:999px;font-size:.72rem;font-weight:700;color:#fff;text-transform:uppercase}
    .badge-received{background:var(--status-received)} .badge-generated{background:var(--status-generated)}
    .badge-waiting{background:var(--status-waiting)} .badge-appropriated{background:var(--status-appropriated)}
    .badge-available{background:var(--status-available)} .badge-delivered{background:var(--status-delivered)}
    .badge-canceled{background:var(--status-canceled)}

    .login-container{display:flex;align-items:center;justify-content:center;min-height:100vh;padding:24px}
    .login-card{max-width:420px;width:100%;padding:28px}

    .modal{display:none;position:fixed;inset:0;z-index:1000}
    .modal.show{display:block}
    .modal-backdrop{position:absolute;inset:0;background:rgba(0,0,0,.55)}
    .modal-container{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:min(100%,1100px);}
    .modal-content{background:#fff;border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,.25);overflow:hidden}
    .modal-header,.modal-footer{padding:14px 16px;border-bottom:1px solid var(--neutral-200);display:flex;align-items:center;justify-content:space-between}
    .modal-footer{border-top:1px solid var(--neutral-200);border-bottom:none}
    .modal-body{padding:16px}

    .overlay-iframe{width:100%;height:70vh;border:0;border-radius:8px;background:#fff}

    @media (max-width:992px){
      .sidebar{width:64px}
      .main-content{margin-left:64px}
      .sidebar-header h1,.user-details,.nav-item span{display:none}
      .search-input{width:100%}
    }
  </style>
</head>
<body>
  <!-- LOGIN -->
  <div id="loginContainer" class="login-container">
    <div class="card login-card">
      <div class="login-header" style="text-align:center;margin-bottom:16px">
        <div style="width:64px;height:64px;background:var(--primary-600);border-radius:12px;display:flex;align-items:center;justify-content:center;margin:0 auto 16px;">
          <i class="fas fa-boxes" style="font-size:28px;color:#fff"></i>
        </div>
        <h1 style="font-size:1.6rem">Gestão de Materiais</h1>
        <p style="color:var(--neutral-600)">Faça login para acessar o painel</p>
      </div>
      <form onsubmit="realizarLogin(event)">
        <div class="form-group" style="margin-bottom:12px">
          <label class="form-label" for="user">Usuário (sem @gmat.com)</label>
          <input id="user" class="search-input" placeholder="ex.: clb354374" required />
        </div>
        <div class="form-group">
          <label class="form-label" for="pass">Senha</label>
          <input id="pass" class="search-input" placeholder="Sua senha" type="password" required />
        </div>
        <p id="loginErro" style="display:none;color:#c62828;margin-top:6px">Falha no login. Verifique usuário/senha.</p>
        <button class="btn btn-primary" style="width:100%;margin-top:12px"><i class="fas fa-right-to-bracket"></i> Entrar</button>
      </form>
      <div class="login-footer" style="text-align:center;margin-top:12px;color:var(--neutral-600);font-size:.85rem">© 2025 Gestão de Materiais</div>
    </div>
  </div>

  <!-- APP -->
  <div id="conteudo" class="app-container" style="display:none">
    <aside class="sidebar">
      <div class="sidebar-header">
        <div style="width:40px;height:40px;background:var(--primary-600);border-radius:8px;display:flex;align-items:center;justify-content:center">
          <i class="fas fa-boxes" style="color:#fff"></i>
        </div>
        <h1>Gestão de Materiais</h1>
      </div>
      <nav class="sidebar-nav">
        <ul>
          <li class="nav-item active"><a href="#dashboard" onclick="mostrarSecao('dashboard')"><i class="fas fa-gauge"></i><span>Dashboard</span></a></li>
          <li class="nav-item"><a href="#pedidos" onclick="mostrarSecao('pedidos')"><i class="fas fa-clipboard-list"></i><span>Pedidos</span></a></li>
          <li class="nav-item"><a href="#catalogo" onclick="mostrarSecao('catalogo')"><i class="fas fa-book"></i><span>Consultar material no catálogo</span></a></li>
          <li class="nav-item"><a href="#importacao" onclick="mostrarSecao('importacao')"><i class="fas fa-file-import"></i><span>Importação</span></a></li>
          <li class="nav-item"><a href="#relatorios" onclick="mostrarSecao('relatorios')"><i class="fas fa-chart-bar"></i><span>Relatórios</span></a></li>
        </ul>
      </nav>
      <div class="sidebar-footer">
        <div class="user-info">
          <div style="width:36px;height:36px;border-radius:50%;background:var(--primary-700);display:flex;align-items:center;justify-content:center;margin-right:10px">
            <i class="fas fa-user" style="color:#fff"></i>
          </div>
        <div class="user-details">
            <span class="user-name">Usuário</span>
            <span class="user-role">Cargo</span>
          </div>
        </div>
        <button class="btn-logout" onclick="realizarLogout()"><i class="fas fa-right-from-brain"></i> Sair</button>
      </div>
    </aside>

    <main class="main-content">
      <!-- DASHBOARD -->
      <section id="secao-dashboard">
        <header class="content-header">
          <div class="page-title">
            <h2>Dashboard</h2>
            <p class="breadcrumb">Home &gt; Dashboard</p>
          </div>
          <div class="header-actions" style="display:flex;gap:8px;align-items:center">
            <input id="buscaTexto" class="search-input" placeholder="Buscar pedidos (qualquer texto)..." />
            <button class="btn btn-primary" onclick="abrirNovoPedido()"><i class="fas fa-plus"></i> Novo Pedido</button>
          </div>
        </header>

        <div class="kpi-cards">
          <div class="card kpi-card" onclick="filtrarPorStatus('')"><div class="kpi-icon"><i class="fas fa-clipboard-list"></i></div><div><div>Total de Pedidos</div><div id="kpi-total" style="font-size:1.3rem;font-weight:700">0</div></div></div>
          <div class="card kpi-card" onclick="filtrarPorStatus('Solicitação Recebida')"><div class="kpi-icon"><i class="fas fa-inbox"></i></div><div><div>Recebidos</div><div id="kpi-recebidos" style="font-size:1.3rem;font-weight:700">0</div></div></div>
          <div class="card kpi-card" onclick="filtrarPorStatus('Reserva Gerada')"><div class="kpi-icon"><i class="fas fa-dolly"></i></div><div><div>Gerados</div><div id="kpi-gerados" style="font-size:1.3rem;font-weight:700">0</div></div></div>
          <div class="card kpi-card" onclick="filtrarPorStatus('Material Entregue')"><div class="kpi-icon"><i class="fas fa-truck"></i></div><div><div>Entregues</div><div id="kpi-entregues" style="font-size:1.3rem;font-weight:700">0</div></div></div>
        </div>

        <div class="grid-layout">
          <div class="card"><div class="card-header"><h3>Status dos Pedidos</h3></div><div class="card-body"><canvas id="graficoStatus" height="220"></canvas></div></div>
          <div class="card"><div class="card-header"><h3>Top 10 materiais mais solicitados</h3></div><div class="card-body"><canvas id="chartTopSolicitados" height="220"></canvas></div></div>
          <div class="card"><div class="card-header"><h3>Top 10 materiais mais entregues</h3></div><div class="card-body"><canvas id="chartTopEntregues" height="220"></canvas></div></div>
          <div class="card"><div class="card-header"><h3>Top 10 materiais mais antigos (abertos)</h3></div><div class="card-body"><canvas id="chartTopAntigos" height="220"></canvas></div></div>
          <div class="card"><div class="card-header"><h3>Top 10 colaboradores com mais entregues</h3></div><div class="card-body"><canvas id="chartTopColabEntregues" height="220"></canvas></div></div>
          <div class="card"><div class="card-header"><h3>Top 10 colaboradores com mais solicitados</h3></div><div class="card-body"><canvas id="chartTopColabSolic" height="220"></canvas></div></div>
          <div class="card"><div class="card-header"><h3>Pedidos por Focal e Status</h3></div><div class="card-body"><canvas id="chartFocalStatus" height="240"></canvas></div></div>
        </div>

        <section>
          <div class="card">
            <div class="card-header"><h3>Pedidos Recentes</h3><button class="btn btn-secondary" onclick="mostrarSecao('pedidos')">Ver todos</button></div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table" id="tabelaPedidosRecentes">
                  <thead><tr><th>Nº</th><th>Colaborador</th><th>Data</th><th>Status</th><th>Ações</th></tr></thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>
        </section>
      </section>

      <!-- PEDIDOS -->
      <section id="secao-pedidos" style="display:none">
        <header class="content-header">
          <div class="page-title"><h2>Pedidos</h2><p class="breadcrumb">Home &gt; Pedidos</p></div>
          <div class="header-actions" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <input id="buscaTextoPedidos" class="search-input" placeholder="Buscar por qualquer texto (nº, colaborador, material, Focal, observações...)" />
            <select id="filtroStatus" class="search-input" style="width:auto">
              <option value="">Todos os Status</option>
              <option>Solicitação Recebida</option>
              <option>Reserva Gerada</option>
              <option>Aguardando Verba</option>
              <option>Reserva Apropriada</option>
              <option>Disponível para Retirada</option>
              <option>Material Entregue</option>
              <option>Pedido Cancelado</option>
              <option>Aguardando Almoxarifado</option>
              <option>Aguardando Material</option>
            </select>
            <select id="filtroFocal" class="search-input" style="width:auto"><option value="">Todos os Focais</option></select>
            <button class="btn btn-primary" onclick="abrirNovoPedido()"><i class="fas fa-plus"></i> Novo Pedido</button>
          </div>
        </header>
        <div id="listaPedidos"></div>
      </section>

      <!-- CATÁLOGO -->
      <section id="secao-catalogo" style="display:none">
        <header class="content-header">
          <div class="page-title"><h2>Consultar material no catálogo</h2><p class="breadcrumb">Home &gt; Catálogo</p></div>
          <div class="header-actions" style="display:flex;gap:8px;align-items:center">
            <input id="buscaCatalogo" class="search-input" placeholder="Pesquisar por nome, código ou qualquer texto..." oninput="filtrarCatalogo()" />
          </div>
        </header>
        <div class="card">
          <div class="card-body">
            <div class="table-responsive">
              <table class="table" id="tabelaCatalogo">
                <thead><tr><th>Código</th><th>Material</th><th>Descrição</th></tr></thead>
                <tbody><tr><td colspan="3">Carregando catálogo...</td></tr></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- IMPORTAÇÃO -->
      <section id="secao-importacao" style="display:none">
        <header class="content-header"><div class="page-title"><h2>Importação</h2><p class="breadcrumb">Home &gt; Importação</p></div></header>
        <div class="card"><div class="card-header"><h3>Atualização em Massa</h3></div>
          <div class="card-body">
            <input type="file" id="arquivoStatus" accept=".xlsx,.xls">
            <button class="btn btn-primary" onclick="atualizarStatusEmMassa()"><i class="fas fa-upload"></i> Atualizar em Massa</button>
          </div>
        </div>
      </section>

      <!-- RELATÓRIOS -->
      <section id="secao-relatorios" style="display:none">
        <header class="content-header"><div class="page-title"><h2>Relatórios</h2><p class="breadcrumb">Home &gt; Relatórios</p></div></header>
        <div class="card">
          <div class="card-header"><h3>Exportar Excel (completo, por item)</h3></div>
          <div class="card-body">
            <p>Exporta os pedidos <b>visíveis/filtrados</b> em nível de <b>item</b>, incluindo: material (descrição e código separados), quantidade, status do item, status do pedido, observações, Focal, colaborador, número e valor da reserva.</p>
            <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
              <button class="btn btn-primary" onclick="exportarExcelCompleto()"><i class="fas fa-file-excel"></i> Exportar Excel Completo</button>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <div class="card-header"><h3>Gerar Relatórios (agregados por pedido)</h3></div>
          <div class="card-body">
            <div class="form-group">
              <label class="form-label" for="tipoRelatorio">Tipo de Relatório:</label>
              <select class="search-input" id="tipoRelatorio" style="width:auto">
                <option value="status">Distribuição por Status</option>
                <option value="mensal">Pedidos por Mês</option>
                <option value="colaborador">Pedidos por Colaborador</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label" for="dataInicioRelatorio">Data Início:</label>
              <input class="search-input" id="dataInicioRelatorio" type="date" style="width:auto"/>
            </div>
            <div class="form-group">
              <label class="form-label" for="dataFimRelatorio">Data Fim:</label>
              <input class="search-input" id="dataFimRelatorio" type="date" style="width:auto"/>
            </div>
            <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:8px">
              <button class="btn btn-primary" onclick="gerarRelatorio()"><i class="fas fa-cogs"></i> Gerar Relatório</button>
              <button class="btn btn-secondary" onclick="exportarRelatorioExcel()"><i class="fas fa-file-export"></i> Exportar Relatório para Excel</button>
            </div>
          </div>
        </div>

        <div class="card" id="resultadoRelatorio" style="margin-top:12px; display:none">
          <div class="card-header"><h3 id="tituloResultadoRelatorio">Resultado do Relatório</h3></div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table" id="tabelaRelatorio">
                <thead></thead><tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- MODAL EDITAR ITEM -->
  <div id="editarItemModal" class="modal">
    <div class="modal-backdrop" onclick="fecharModal('editarItemModal')"></div>
    <div class="modal-container" style="max-width:640px">
      <div class="modal-content">
        <div class="modal-header">
          <h4>Editar Item</h4>
          <button class="btn-icon" onclick="fecharModal('editarItemModal')"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body">
          <div style="display:grid;grid-template-columns:1fr 140px;gap:12px">
            <div>
              <label class="form-label">Material</label>
              <input id="editMaterialNome" class="search-input" placeholder="Nome do material">
            </div>
            <div>
              <label class="form-label">Quantidade</label>
              <input id="editMaterialQtd" class="search-input" type="number" min="1" placeholder="Qtd">
            </div>
          </div>
          <input id="editPedidoId" type="hidden"><input id="editItemIndex" type="hidden">
          <p id="editAviso" style="margin-top:8px;color:#c62828;display:none"></p>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="fecharModal('editarItemModal')">Cancelar</button>
          <button class="btn btn-primary" onclick="salvarEdicaoItem()">Salvar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL NOVO PEDIDO -->
  <div id="novoPedidoModal" class="modal">
    <div class="modal-backdrop" onclick="fecharModal('novoPedidoModal')"></div>
    <div class="modal-container">
      <div class="modal-content">
        <div class="modal-header">
          <h4>Novo Pedido</h4>
          <button class="btn-icon" onclick="fecharModal('novoPedidoModal')"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body">
          <iframe id="iframeIndex" class="overlay-iframe" src="Index.html"></iframe>
          <div style="margin-top:10px;display:flex;justify-content:flex-end">
            <button class="btn btn-secondary" onclick="fecharModal('novoPedidoModal')"><i class="fas fa-arrow-left"></i> Voltar</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // =================== CONFIG FIREBASE ===================
    const firebaseConfig = {
      apiKey: "AIzaSyCv7vfGMSobE1n0M1CECl46LdMy3pdrxh4",
      authDomain: "pedido-de-material---ilheus.firebaseapp.com",
      projectId: "pedido-de-material---ilheus",
      storageBucket: "pedido-de-material---ilheus.firebasestorage.app",
      messagingSenderId: "155845988594",
      appId: "1:155845988594:web:322f34f9790f605a92006b"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // =================== CONSTANTES ===================
    const STATUS_OPTIONS = [
      "Solicitação Recebida","Reserva Gerada","Aguardando Verba","Reserva Apropriada",
      "Disponível para Retirada","Material Entregue","Pedido Cancelado","Aguardando Almoxarifado","Aguardando Material"
    ];
    const STATUS_COLORS = {
      "Solicitação Recebida":"#9c27b0","Reserva Gerada":"#1976d2","Aguardando Verba":"#FFA500","Reserva Apropriada":"#ec407a",
      "Disponível para Retirada":"#757575","Material Entregue":"#2e7d32","Pedido Cancelado":"#ff0000",
      "Aguardando Almoxarifado":"#7cb342","Aguardando Material":"#fb8c00"
    };
    const STATUS_BADGES = {
      "Solicitação Recebida":"badge-received","Reserva Gerada":"badge-generated","Aguardando Verba":"badge-waiting",
      "Reserva Apropriada":"badge-appropriated","Disponível para Retirada":"badge-available","Material Entregue":"badge-delivered","Pedido Cancelado":"badge-canceled"
    };

    // =================== UTIL: Reserva em Observações ===================
    function appendReservaToObservacoes(observacoes, numero, valor){
      const parts = [];
      if(observacoes && observacoes.trim()) parts.push(observacoes.trim());
      if(numero){ parts.push(`Reserva: ${String(numero).trim()}`); }
      if(valor){ parts.push(`Valor: ${String(valor).trim()}`); }
      return parts.join(' | ');
    }
    function extractReservaFromObservacoes(obs){
      if(!obs) return {numero:'', valor:''};
      const numeroMatch = obs.match(/Reserva\s*[:\-]?\s*([A-Za-z0-9\-\/\.]+)/i);
      const valorMatch  = obs.match(/Valor\s*[:\-]?\s*([0-9\.\,]+)/i);
      return { numero: numeroMatch ? numeroMatch[1] : '', valor: valorMatch ? valorMatch[1] : '' };
    }


    // =================== ESTADO ===================
    let usuarioAtual = null; // {username, email, nome, cargo}
    let todosPedidos = [];
    let pedidosFiltrados = [];
    let filtros = { texto:"", status:"", focal:"" };
    let charts = {};
    let dadosRelatorio = []; // para exportar o agregado
    let cabecalhoRelatorio = []; let tituloRelatorio = '';

    // Index detectado
    let indexUsadoGlobal = 'Index.html';

    // =================== LOGIN ===================
    async function realizarLogin(ev){
      ev.preventDefault();
      const username = document.getElementById('user').value.trim();
      const senha = document.getElementById('pass').value;
      const email = username.includes('@') ? username : (username + '@gmat.com');

      try{
        await auth.signInWithEmailAndPassword(email, senha);
        const user = auth.currentUser;
        let perfil = { nome: "", cargo: "" };
        const docId = username.toLowerCase();
        let snap = await db.collection('usuarios').doc(docId).get();
        if(!snap.exists) snap = await db.collection('usuarios').doc(user.uid).get();
        if(snap.exists){ const d = snap.data(); perfil.nome = d.nome||""; perfil.cargo = d.cargo||""; }
        usuarioAtual = { username: docId, email, nome: perfil.nome||email, cargo: perfil.cargo||"Usuário" };
        localStorage.setItem("usuarioLogado", JSON.stringify({ ...usuarioAtual, ts: Date.now() }));

        document.getElementById('loginContainer').style.display='none';
        document.getElementById('conteudo').style.display='flex';
        document.querySelector('.user-name').textContent = usuarioAtual.nome;
        document.querySelector('.user-role').textContent = usuarioAtual.cargo;
        iniciarListeners();
      }catch(err){
        console.error(err);
        document.getElementById('loginErro').style.display='block';
      }
    }
    auth.onAuthStateChanged(async (user)=>{
      if(user){
        const saved = JSON.parse(localStorage.getItem("usuarioLogado")||"null");
        if(saved && Date.now()-saved.ts < 30*60*1000){
          usuarioAtual = saved;
          document.getElementById('loginContainer').style.display='none';
          document.getElementById('conteudo').style.display='flex';
          document.querySelector('.user-name').textContent = usuarioAtual.nome;
          document.querySelector('.user-role').textContent = usuarioAtual.cargo;
          iniciarListeners();
        }
      }
    });
    async function realizarLogout(){
      try{ await auth.signOut(); }catch(e){}
      localStorage.removeItem("usuarioLogado");
      usuarioAtual = null;
      document.getElementById('conteudo').style.display='none';
      document.getElementById('loginContainer').style.display='flex';
    }

    // =================== NAVEGAÇÃO ===================
    function mostrarSecao(sec){
      ['dashboard','pedidos','catalogo','importacao','relatorios'].forEach(id=>{
        document.getElementById('secao-'+id).style.display = (id===sec)?'block':'none';
      });
      document.querySelectorAll('.nav-item').forEach(li=>li.classList.remove('active'));
      const link = document.querySelector('.nav-item a[href="#'+sec+'"]');
      if(link) link.parentElement.classList.add('active');
    }

    // =================== LISTENERS / DADOS ===================
    
    async function carregarCatalogoDeIndex(){
      const candidatos = ['Index.html','index.html','index (2).html'];
      let text = null, usado = null;
      for(const nome of candidatos){
        try{
          const resp = await fetch(nome, {cache:'no-store'});
          if(resp.ok){
            text = await resp.text();
            usado = nome;
            indexUsadoGlobal = nome;
            break;
          }
        }catch(e){ /* tenta próximo */ }
      }
      if(!text) {
        const tbody = document.querySelector('#tabelaCatalogo tbody');
        tbody.innerHTML = '<tr><td colspan="3">Não foi possível carregar o catálogo a partir do Index.*</td></tr>';
        return;
      }
      try{
        const start = text.indexOf('const materiais =');
        if(start === -1) throw new Error('Lista de materiais não encontrada no '+usado);
        const sub = text.slice(start);
        const end = sub.indexOf('};');
        if(end === -1) throw new Error('Fechamento do objeto de materiais não encontrado em '+usado);
        const objetoLiteral = sub.slice(sub.indexOf('=')+1, end+1).trim();
        let materiaisObj;
        try{
          materiaisObj = (new Function(`return (${objetoLiteral});`))();
        }catch(e){
          console.error('Falha ao interpretar materiais do Index:', e);
          throw e;
        }
        const tbody = document.querySelector('#tabelaCatalogo tbody');
        tbody.innerHTML='';
        const categorias = Object.keys(materiaisObj||{});
        let total=0;
        categorias.forEach(cat=>{
          (materiaisObj[cat]||[]).forEach(item=>{
            total++;
            tbody.insertAdjacentHTML('beforeend', `<tr class="row-catalogo"><td></td><td>${item}</td><td>${cat}</td></tr>`);
          });
        });
        if(total===0){
          tbody.innerHTML = '<tr><td colspan="3">Nenhum material encontrado no Index.</td></tr>';
        }
      }catch(err){
        console.error(err);
        const tbody = document.querySelector('#tabelaCatalogo tbody');
        tbody.innerHTML = '<tr><td colspan="3">Falha ao interpretar a lista de materiais do Index.</td></tr>';
      }
    }

function iniciarListeners(){
      db.collection('pedidos').orderBy('data','desc').onSnapshot(snap=>{
        todosPedidos = snap.docs.map(d=>({ id:d.id, ...d.data() }));
        aplicarFiltrosPersistentes();
        renderizarPedidos(pedidosFiltrados);
        atualizarTabelaPedidosRecentes();
        atualizarKPIs(todosPedidos);
        gerarTodosGraficos(todosPedidos);
        popularFiltroFocal(todosPedidos);
      });
      
      // Carregar catálogo a partir do Index.html (mesma pasta)
      carregarCatalogoDeIndex();
tbody.innerHTML = '<tr><td colspan="3">Não foi possível carregar o catálogo (crie a coleção "catalogoMateriais").</td></tr>';
      });

      document.getElementById('buscaTexto').addEventListener('input', e=>{ filtros.texto = e.target.value.toLowerCase(); aplicarFiltrosPersistentes(true); renderizarPedidos(pedidosFiltrados); });
      document.getElementById('buscaTextoPedidos').addEventListener('input', e=>{ filtros.texto = e.target.value.toLowerCase(); aplicarFiltrosPersistentes(true); renderizarPedidos(pedidosFiltrados); });
      document.getElementById('filtroStatus').addEventListener('change', e=>{ filtros.status = e.target.value; aplicarFiltrosPersistentes(true); renderizarPedidos(pedidosFiltrados); });
      document.getElementById('filtroFocal').addEventListener('change', e=>{ filtros.focal = e.target.value; aplicarFiltrosPersistentes(true); renderizarPedidos(pedidosFiltrados); });
    }

    function aplicarFiltrosPersistentes(save=false){
      let lista = [...todosPedidos];
      const {texto,status,focal} = filtros;
      if(texto){
        lista = lista.filter(p=>{ try{ return JSON.stringify(p).toLowerCase().includes(texto); }catch{return false;} });
      }
      if(status){ lista = lista.filter(p=> (p.status===status)); }
      if(focal){ lista = lista.filter(p=> (String(p.Focal||'')===focal)); }
      pedidosFiltrados = lista;
      if(save){
        localStorage.setItem('filtrosPedidos', JSON.stringify(filtros));
      }else{
        const saved = JSON.parse(localStorage.getItem('filtrosPedidos')||'null');
        if(saved){ filtros = saved; }
        document.getElementById('filtroStatus').value = filtros.status||'';
        document.getElementById('filtroFocal').value = filtros.focal||'';
        document.getElementById('buscaTexto').value = filtros.texto||'';
        document.getElementById('buscaTextoPedidos').value = filtros.texto||'';
        let l2 = [...todosPedidos];
        if(filtros.texto){ l2 = l2.filter(p=>JSON.stringify(p).toLowerCase().includes(filtros.texto)); }
        if(filtros.status){ l2 = l2.filter(p=>p.status===filtros.status); }
        if(filtros.focal){ l2 = l2.filter(p=>String(p.Focal||'')===filtros.focal); }
        pedidosFiltrados = l2;
      }
    }

    // =================== UI: PEDIDOS ===================
    function popularFiltroFocal(lista){
      const focals = Array.from(new Set(lista.map(p=>p.Focal).filter(Boolean))).sort();
      const sel = document.getElementById('filtroFocal');
      sel.innerHTML = '<option value="">Todos os Focais</option>' + focals.map(f=>`<option>${f}</option>`).join('');
      if(filtros.focal) sel.value = filtros.focal;
    }
    function badgeStatus(s){
      const cls = STATUS_BADGES[s]||'badge-received';
      return `<span class="badge ${cls}">${s||'-'}</span>`;
    }

    function renderizarPedidos(lista){
      const div = document.getElementById('listaPedidos');
      div.innerHTML='';
      if(!lista || !lista.length){
        div.innerHTML = '<div class="card"><div class="card-body" style="text-align:center;color:var(--neutral-600)">Nenhum pedido</div></div>';
        return;
      }
      lista.forEach(p=>{
        const historico = (p.historico||[]).map(h=>{
          const when = new Date(h.data||Date.now()).toLocaleString();
          const who = h.usuarioNome ? ` • ${h.usuarioNome}` : '';
          const extra = h.detalhes ? ` • ${h.detalhes}` : '';
          return `<li>${when}${who} — ${h.acao||h.status||'alteração'}${extra?(' ('+extra+')'):''}</li>`;
        }).join('');

        const matRows = (p.materiais||[]).map((m,idx)=>{
          const sel = `<select class="search-input" style="width:auto" onchange="alterarStatusItem('${p.id}',${idx},this)">
              ${STATUS_OPTIONS.map(s=>`<option ${((m.status||p.status)===s)?'selected':''}>${s}</option>`).join('')}
            </select>`;
          return `
          <tr>
            <td>${m.material||'-'}</td>
            <td>${m.quantidade||0}</td>
            <td>${badgeStatus(m.status||p.status||'-')}</td>
            <td>${sel}</td>
            <td><button class="btn btn-secondary" onclick="abrirEditarItem('${p.id}',${idx})"><i class="fas fa-pen"></i> Editar</button></td>
          </tr>`;
        }).join('');

        const selectStatus = `<select class="search-input" style="width:auto" onchange="alterarStatusPedido('${p.id}', this.value)">
            ${STATUS_OPTIONS.map(s=>`<option ${p.status===s?'selected':''}>${s}</option>`).join('')}
          </select>`;

        div.insertAdjacentHTML('beforeend',`
          <div class="card">
            <div class="card-body">
              <div style="display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap">
                <div style="font-weight:700;color:var(--secondary-500)">Pedido: ${p.numero||p.id}</div>
                <div style="color:var(--neutral-600)">${new Date(p.data||Date.now()).toLocaleString()}</div>
              </div>
              <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:8px;margin-top:10px">
                <div><b>Colaborador:</b> ${p.colaborador||'-'}</div>
                <div><b>Focal:</b> ${p.Focal||'-'}</div>
                <div><b>Observações:</b> ${p.observacoes||'-'}</div>
              </div>

              <div style="margin-top:12px">
                <h4 style="margin-bottom:8px">Materiais</h4>
                <div class="table-responsive">
                  <table class="table"><thead><tr><th>Material</th><th>Qtd</th><th>Status</th><th>Alterar status do item</th><th>Ações</th></tr></thead><tbody>${matRows}</tbody></table>
                </div>
              </div>

              <div style="display:flex;gap:10px;align-items:center;margin-top:12px;flex-wrap:wrap">
                <div><b>Status do Pedido:</b> ${selectStatus}</div>
                <small style="color:var(--neutral-600)">Ao alterar o status geral, os itens serão atualizados com o mesmo status.</small>
              </div>

              <div style="margin-top:14px;border-top:1px solid var(--neutral-200);padding-top:10px">
                <h4 style="margin-bottom:6px">Histórico</h4>
                <ul style="padding-left:18px">${historico||'<li>Sem histórico</li>'}</ul>
              </div>
            </div>
          </div>
        `);
      });
    }

    // Editar item (somente com pedido em "Solicitação Recebida")
    function abrirEditarItem(pedidoId, idx){
      const p = todosPedidos.find(x=>x.id===pedidoId);
      if(!p) return;
      if(p.status !== "Solicitação Recebida"){
        document.getElementById('editAviso').textContent = 'Edição permitida apenas quando o pedido está em "Solicitação Recebida".';
        document.getElementById('editAviso').style.display='block';
      }else{
        document.getElementById('editAviso').style.display='none';
      }
      const m = (p.materiais||[])[idx]||{};
      document.getElementById('editPedidoId').value = pedidoId;
      document.getElementById('editItemIndex').value = idx;
      document.getElementById('editMaterialNome').value = m.material||'';
      document.getElementById('editMaterialQtd').value = m.quantidade||1;
      abrirModal('editarItemModal');
    }

    async function salvarEdicaoItem(){
      const pedidoId = document.getElementById('editPedidoId').value;
      const idx = parseInt(document.getElementById('editItemIndex').value,10);
      const nome = document.getElementById('editMaterialNome').value.trim();
      const qtd = parseInt(document.getElementById('editMaterialQtd').value,10)||1;

      const docRef = db.collection('pedidos').doc(pedidoId);
      const snap = await docRef.get();
      if(!snap.exists) return;
      const p = snap.data();
      if(p.status !== "Solicitação Recebida"){ alert('Edição permitida apenas quando o pedido está em "Solicitação Recebida".'); return; }
      const materiais = p.materiais||[];
      if(!materiais[idx]) return;
      materiais[idx].material = nome;
      materiais[idx].quantidade = qtd;

      const historico = p.historico||[];
      historico.push({
        data: new Date().toISOString(),
        usuarioId: (usuarioAtual && usuarioAtual.username)||'',
        usuarioNome: (usuarioAtual && usuarioAtual.nome)||'',
        acao: 'Editar item',
        detalhes: `Item ${idx+1}: ${nome} (Qtd: ${qtd})`
      });

      await docRef.update({ materiais, historico });
      fecharModal('editarItemModal');
    }

    // Alterar Status do pedido (mantém filtros; cancelado pede justificativa)
    
    async function alterarStatusPedido(pedidoId, novoStatus){
      const docRef = db.collection('pedidos').doc(pedidoId);
      const snap = await docRef.get();
      if(!snap.exists) return;
      const p = snap.data();

      // Confirmação genérica
      const confirmMsg = `Confirmar alteração do status do pedido "${p.numero||pedidoId}" de "${p.status||'-'}" para "${novoStatus}"?`;
      if(!confirm(confirmMsg)){ return; }

      let observacoes = p.observacoes||'';

      if(novoStatus === 'Pedido Cancelado'){
        const justificativa = prompt('Informe a justificativa do cancelamento:');
        if(!justificativa){ return; }
        observacoes = (observacoes? (observacoes + ' | ') : '') + 'Pedido cancelado devido à: ' + justificativa;
      }

      if(novoStatus === 'Reserva Gerada'){
        const numero = prompt('Informe o NÚMERO da reserva (pedido):');
        if(numero === null || numero === ''){ return; }
        const valor = prompt('Informe o VALOR da reserva (pedido):');
        if(valor === null || valor === ''){ return; }
        observacoes = appendReservaToObservacoes(observacoes, numero, valor);
      }

      // Atualiza TODOS os itens com o novo status geral
      const materiais = (p.materiais||[]).map(m=>({ ...m, status: novoStatus }));

      const historico = p.historico||[];
      historico.push({
        data: new Date().toISOString(),
        usuarioId: (usuarioAtual && usuarioAtual.username)||'',
        usuarioNome: (usuarioAtual && usuarioAtual.nome)||'',
        acao: 'Alteração de status (pedido)',
        statusAnterior: p.status||'',
        statusNovo: novoStatus,
        detalhes: (novoStatus==='Pedido Cancelado' ? 'Com justificativa' : (novoStatus==='Reserva Gerada' ? 'Reserva registrada' : ''))
      });

      await docRef.update({ status: novoStatus, materiais, observacoes, historico });
      aplicarFiltrosPersistentes(true);
    }
        observacoes = (observacoes? (observacoes + ' | ') : '') + 'Pedido cancelado devido à: ' + justificativa;
      }

      // Atualiza TODOS os itens com o novo status geral
      const materiais = (p.materiais||[]).map(m=>({ ...m, status: novoStatus }));

      const historico = p.historico||[];
      historico.push({
        data: new Date().toISOString(),
        usuarioId: (usuarioAtual && usuarioAtual.username)||'',
        usuarioNome: (usuarioAtual && usuarioAtual.nome)||'',
        acao: 'Alteração de status (pedido)',
        statusAnterior: p.status||'',
        statusNovo: novoStatus,
        detalhes: novoStatus==='Pedido Cancelado' ? 'Com justificativa' : ''
      });

      await docRef.update({ status: novoStatus, materiais, observacoes, historico });
      aplicarFiltrosPersistentes(true);
    }

    // Alterar Status do ITEM (com prompts para reserva nº e valor quando aplicável) + reverter seleção se cancelar
    async function alterarStatusItem(pedidoId, idx, selectEl){
      const novoStatus = selectEl.value;
      const docRef = db.collection('pedidos').doc(pedidoId);
      const snap = await docRef.get();
      if(!snap.exists) return;
      const p = snap.data();
      const materiais = p.materiais||[];
      if(!materiais[idx]) return;

      const antigo = materiais[idx].status || p.status || '';

      
      const conf = confirm(`Confirmar alteração do status do item ${idx+1} de "${antigo||'-'}" para "${novoStatus}"?`);
      if(!conf){ selectEl.value = antigo; return; }
// Coletar reserva quando necessário
      let nReserva = materiais[idx].reservaNumero || '';
      let vReserva = materiais[idx].reservaValor || '';
      if(novoStatus === 'Reserva Gerada' || novoStatus === 'Reserva Apropriada'){
        const nr = prompt('Informe o NÚMERO da reserva do item:', nReserva);
        if(nr === null || nr === ''){ selectEl.value = antigo; return; } // reverte
        const vr = prompt('Informe o VALOR da reserva (apenas números ou 0,00):', vReserva);
        if(vr === null || vr === ''){ selectEl.value = antigo; return; } // reverte
        nReserva = String(nr).trim(); vReserva = String(vr).trim();
      }

      materiais[idx].status = novoStatus;
      if(nReserva) materiais[idx].reservaNumero = nReserva;
      if(vReserva) materiais[idx].reservaValor = vReserva;

      const historico = p.historico||[];
      historico.push({
        data: new Date().toISOString(),
        usuarioId: (usuarioAtual && usuarioAtual.username)||'',
        usuarioNome: (usuarioAtual && usuarioAtual.nome)||'',
        acao: 'Alteração de status (item)',
        detalhes: `Item ${idx+1}: ${antigo} → ${novoStatus}`
      });

      await docRef.update({ materiais, historico });
    }

    // =================== TABELA RECENTES & KPIs ===================
    function atualizarTabelaPedidosRecentes(){
      const tbody = document.querySelector('#tabelaPedidosRecentes tbody');
      tbody.innerHTML='';
      (todosPedidos.slice(0,10)).forEach(p=>{
        tbody.insertAdjacentHTML('beforeend',`
          <tr>
            <td>${p.numero||p.id}</td>
            <td>${p.colaborador||'-'}</td>
            <td>${new Date(p.data||Date.now()).toLocaleString()}</td>
            <td>${badgeStatus(p.status||'-')}</td>
            <td><button class="btn btn-secondary" onclick="mostrarSecao('pedidos')">Abrir</button></td>
          </tr>
        `);
      });
    }
    function atualizarKPIs(lista){
      const total = (lista||[]).length;
      const get = (s)=> (lista||[]).filter(p=>p.status===s).length;
      document.getElementById('kpi-total').textContent = total;
      document.getElementById('kpi-recebidos').textContent = get('Solicitação Recebida');
      document.getElementById('kpi-gerados').textContent = get('Reserva Gerada');
      document.getElementById('kpi-entregues').textContent = get('Material Entregue');
    }

    // =================== GRÁFICOS ===================
    function destroyChart(id){ if(charts[id]){ charts[id].destroy(); delete charts[id]; } }

    function gerarTodosGraficos(lista){
      gerarGraficoStatus(lista);
      chartTopMateriaisSolicitados(lista);
      chartTopMateriaisEntregues(lista);
      chartTopMateriaisAntigos(lista);
      chartTopColaboradoresEntregues(lista);
      chartTopColaboradoresSolicitados(lista);
      chartPedidosPorFocalStatus(lista);
    }
    function gerarGraficoStatus(lista){
      const counts = STATUS_OPTIONS.reduce((acc,s)=> (acc[s]=0,acc),{});
      (lista||[]).forEach(p=>{ counts[p.status] = (counts[p.status]||0)+1; });
      const labels = STATUS_OPTIONS;
      const data = labels.map(l=>counts[l]||0);
      destroyChart('graficoStatus');
      charts.graficoStatus = new Chart(document.getElementById('graficoStatus').getContext('2d'),{
        type:'bar',
        data:{ labels, datasets:[{ label:'Pedidos', data, backgroundColor: labels.map(l=>STATUS_COLORS[l]||'#90caf9') }]},
        options:{ plugins:{ legend:{display:false}, datalabels:{anchor:'end',align:'top'}}, responsive:true, scales:{ y:{ beginAtZero:true } } }
      });
    }
    function acumularMateriais(lista, filtroItem = ()=>true){
      const mapa = new Map();
      (lista||[]).forEach(p=> (p.materiais||[]).forEach(m=>{
        if(!filtroItem(m,p)) return;
        const key = (m.material||'Sem nome').trim();
        const qtd = Number(m.quantidade||1);
        mapa.set(key, (mapa.get(key)||0)+qtd);
      }));
      return Array.from(mapa.entries()).sort((a,b)=>b[1]-a[1]).slice(0,10);
    }
    function chartTopMateriaisSolicitados(lista){
      const top = acumularMateriais(lista, ()=>true);
      const labels = top.map(x=>x[0]); const data = top.map(x=>x[1]);
      destroyChart('chartTopSolicitados');
      charts.chartTopSolicitados = new Chart(document.getElementById('chartTopSolicitados').getContext('2d'),{
        type:'bar', data:{ labels, datasets:[{ label:'Qtd Itens', data }]},
        options:{ plugins:{ legend:{display:false} }, responsive:true, scales:{ y:{beginAtZero:true} } }
      });
    }
    function chartTopMateriaisEntregues(lista){
      const top = acumularMateriais(lista, (m)=> (m.status==='Material Entregue'));
      const labels = top.map(x=>x[0]); const data = top.map(x=>x[1]);
      destroyChart('chartTopEntregues');
      charts.chartTopEntregues = new Chart(document.getElementById('chartTopEntregues').getContext('2d'),{
        type:'bar', data:{ labels, datasets:[{ label:'Qtd Entregue', data }]},
        options:{ plugins:{ legend:{display:false} }, responsive:true, scales:{ y:{beginAtZero:true} } }
      });
    }
    function chartTopMateriaisAntigos(lista){
      const hoje = Date.now();
      const mapa = new Map();
      (lista||[]).forEach(p=>{
        const idadeDias = Math.max(0, Math.floor((hoje - (p.data||Date.now()))/86400000));
        (p.materiais||[]).forEach(m=>{
          if(m.status==='Material Entregue') return;
          const key = (m.material||'Sem nome').trim();
          mapa.set(key, Math.max(mapa.get(key)||0, idadeDias));
        });
      });
      const arr = Array.from(mapa.entries()).sort((a,b)=>b[1]-a[1]).slice(0,10);
      const labels = arr.map(x=>x[0]); const data = arr.map(x=>x[1]);
      destroyChart('chartTopAntigos');
      charts.chartTopAntigos = new Chart(document.getElementById('chartTopAntigos').getContext('2d'),{
        type:'bar', data:{ labels, datasets:[{ label:'Dias em aberto (máx.)', data }]},
        options:{ plugins:{ legend:{display:false} }, responsive:true, scales:{ y:{beginAtZero:true} } }
      });
    }
    function chartTopColaboradoresEntregues(lista){
      const mapa = new Map();
      (lista||[]).forEach(p=> (p.materiais||[]).forEach(m=>{
        if(m.status==='Material Entregue'){
          mapa.set(p.colaborador||'-', (mapa.get(p.colaborador||'-')||0) + Number(m.quantidade||1));
        }
      }));
      const arr = Array.from(mapa.entries()).sort((a,b)=>b[1]-a[1]).slice(0,10);
      const labels = arr.map(x=>x[0]); const data = arr.map(x=>x[1]);
      destroyChart('chartTopColabEntregues');
      charts.chartTopColabEntregues = new Chart(document.getElementById('chartTopColabEntregues').getContext('2d'),{
        type:'bar', data:{ labels, datasets:[{ label:'Qtd Itens Entregues', data }]},
        options:{ plugins:{ legend:{display:false} }, responsive:true, scales:{ y:{beginAtZero:true} } }
      });
    }
    function chartTopColaboradoresSolicitados(lista){
      const mapa = new Map();
      (lista||[]).forEach(p=> (p.materiais||[]).forEach(m=>{
        mapa.set(p.colaborador||'-', (mapa.get(p.colaborador||'-')||0) + Number(m.quantidade||1));
      }));
      const arr = Array.from(mapa.entries()).sort((a,b)=>b[1]-a[1]).slice(0,10);
      const labels = arr.map(x=>x[0]); const data = arr.map(x=>x[1]);
      destroyChart('chartTopColabSolic');
      charts.chartTopColabSolic = new Chart(document.getElementById('chartTopColabSolic').getContext('2d'),{
        type:'bar', data:{ labels, datasets:[{ label:'Qtd Itens Solicitados', data }]},
        options:{ plugins:{ legend:{display:false} }, responsive:true, scales:{ y:{beginAtZero:true} } }
      });
    }
    function chartPedidosPorFocalStatus(lista){
      const focals = Array.from(new Set((lista||[]).map(p=>p.Focal).filter(Boolean))).sort();
      const porStatus = STATUS_OPTIONS.reduce((acc,s)=> (acc[s]=focals.map(()=>0),acc),{});
      (lista||[]).forEach(p=>{
        const i = focals.indexOf(p.Focal);
        if(i>=0){ porStatus[p.status] = porStatus[p.status] || focals.map(()=>0); porStatus[p.status][i] += 1; }
      });
      const datasets = STATUS_OPTIONS.map(s=>({
        label:s, backgroundColor: STATUS_COLORS[s]||'#90caf9', data: porStatus[s]||focals.map(()=>0), stack:'stack1'
      }));
      destroyChart('chartFocalStatus');
      charts.chartFocalStatus = new Chart(document.getElementById('chartFocalStatus').getContext('2d'),{
        type:'bar', data:{ labels:focals, datasets },
        options:{ plugins:{ legend:{position:'bottom'} }, responsive:true, scales:{ x:{stacked:true}, y:{stacked:true, beginAtZero:true} } }
      });
    }

    // =================== EXPORTAÇÃO EXCEL COMPLETO (detalhado por item) ===================
            
    function flattenPedidos(lista){
      const rows = [];
      (lista||[]).forEach(p=>{
        const base = {
          PedidoID: p.id,
          NumeroPedido: p.numero||p.id,
          DataISO: p.data ? new Date(p.data).toISOString() : '',
          DataLocal: p.data ? new Date(p.data).toLocaleString() : '',
          Colaborador: p.colaborador||'',
          Focal: p.Focal||'',
          Observacoes: p.observacoes||'',
          StatusPedido: p.status||''
        };
        const rv = extractReservaFromObservacoes(base.Observacoes);
        if((p.materiais||[]).length===0){
          rows.push({ ...base, ItemIndex:'', Material:'', Quantidade:'', StatusItem:'', ReservaNumero: rv.numero, ReservaValor: rv.valor });
        }else{
          (p.materiais||[]).forEach((m,idx)=>{
            rows.push({
              ...base,
              ItemIndex: idx+1,
              Material: m.material||'',
              Quantidade: m.quantidade||'',
              StatusItem: m.status||p.status||'',
              ReservaNumero: rv.numero,
              ReservaValor: rv.valor
            });
          });
        }
      });
      return rows;
    }
      });
      return rows;
    }
    function exportarExcelCompleto(){
      const rows = flattenPedidos(pedidosFiltrados);
      if(rows.length===0){ alert('Nada para exportar.'); return; }
      const ws = XLSX.utils.json_to_sheet(rows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Pedidos');
      XLSX.writeFile(wb, 'Relatorio_Pedidos_Completo.xlsx');
    }

    // =================== RELATÓRIOS AGREGADOS ===================
    function filtrarPorData(base){
      const di = document.getElementById('dataInicioRelatorio').value;
      const df = document.getElementById('dataFimRelatorio').value;
      const start = di ? new Date(di + 'T00:00:00') : null;
      const end = df ? new Date(df + 'T23:59:59') : null;
      return base.filter(p=>{
        const d = p.data ? new Date(p.data) : null;
        if(!d) return false;
        if(start && d < start) return false;
        if(end && d > end) return false;
        return true;
      });
    }
    function gerarRelatorio(){
      const tipo = document.getElementById('tipoRelatorio').value;
      const base = filtrarPorData([...todosPedidos]);
      let head=[], rows=[];
      if(tipo==='status'){
        const counts = {};
        base.forEach(p=>{ counts[p.status||'-'] = (counts[p.status||'-']||0)+1; });
        head = ['Status','Qtde de Pedidos'];
        rows = Object.entries(counts).sort((a,b)=>b[1]-a[1]);
        tituloRelatorio = 'Distribuição por Status';
      }else if(tipo==='mensal'){
        const counts = {};
        base.forEach(p=>{
          const d = p.data ? new Date(p.data) : null;
          if(!d) return;
          const ym = d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0');
          counts[ym] = (counts[ym]||0)+1;
        });
        head = ['Ano-Mês','Qtde de Pedidos'];
        rows = Object.entries(counts).sort((a,b)=> a[0].localeCompare(b[0]));
        tituloRelatorio = 'Pedidos por Mês';
      }else{ // colaborador
        const counts = {};
        base.forEach(p=>{ const k = p.colaborador||'-'; counts[k] = (counts[k]||0)+1; });
        head = ['Colaborador','Qtde de Pedidos'];
        rows = Object.entries(counts).sort((a,b)=>b[1]-a[1]);
        tituloRelatorio = 'Pedidos por Colaborador';
      }
      // preencher tabela
      const thead = document.querySelector('#tabelaRelatorio thead');
      const tbody = document.querySelector('#tabelaRelatorio tbody');
      thead.innerHTML = '<tr>'+head.map(h=>`<th>${h}</th>`).join('')+'</tr>';
      tbody.innerHTML = rows.map(r=>'<tr>'+r.map(c=>`<td>${c}</td>`).join('')+'</tr>').join('');
      document.getElementById('tituloResultadoRelatorio').textContent = tituloRelatorio;
      document.getElementById('resultadoRelatorio').style.display='block';
      // guardar para export
      cabecalhoRelatorio = head;
      dadosRelatorio = rows.map(r=>{ const obj={}; obj[head[0]]=r[0]; obj[head[1]]=r[1]; return obj; });
    }
    function exportarRelatorioExcel(){
      if(!dadosRelatorio || dadosRelatorio.length===0){ alert('Gere o relatório primeiro.'); return; }
      const ws = XLSX.utils.json_to_sheet(dadosRelatorio);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Relatorio');
      XLSX.writeFile(wb, 'Relatorio_Agregado.xlsx');
    }

    // =================== MISC ===================
    function abrirModal(id){ document.getElementById(id).classList.add('show'); }
    function fecharModal(id){ document.getElementById(id).classList.remove('show'); }
    function abrirNovoPedido(){
      const iframe = document.getElementById('iframeIndex');
      if(iframe){
        iframe.src = indexUsadoGlobal || 'Index.html';
      }
      abrirModal('novoPedidoModal');
    }
    function filtrarPorStatus(s){ filtros.status=s; localStorage.setItem('filtrosPedidos', JSON.stringify(filtros)); mostrarSecao('pedidos'); aplicarFiltrosPersistentes(true); renderizarPedidos(pedidosFiltrados); }

    function filtrarCatalogo(){
      const q = (document.getElementById('buscaCatalogo').value||'').toLowerCase();
      document.querySelectorAll('#tabelaCatalogo .row-catalogo').forEach(tr=>{
        const txt = tr.innerText.toLowerCase();
        tr.style.display = txt.includes(q)?'':'none';
      });
    }

    function atualizarStatusEmMassa(){ alert('Importação em massa: implementar conforme necessidade.'); }
  </script>
</body>
</html>
